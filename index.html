<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
  <title>Ù…Ù†ØµØ© Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø±Ø§Øª - Ø§Ù„Ø·Ø§Ù„Ø¨</title>

  <!-- PWA Meta Tags -->
  <link rel="manifest" href="./manifest.json">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="apple-mobile-web-app-title" content="Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø±Ø§Øª">
  <link rel="apple-touch-icon" href="https://i.postimg.cc/3RBYLnd3/818334fa-20ba-431a-ad38-6bec7ef02203.png">
  <meta name="theme-color" content="#3081f7">

  <!-- Open Graph Meta Tags for social sharing -->
  <meta property="og:title" content="Ù…Ù†ØµØ© Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø±Ø§Øª Ø§Ù„ØªØ¹Ù„ÙŠÙ…ÙŠØ© Ù„Ù„Ø·Ù„Ø§Ø¨" />
  <meta property="og:description" content="Ù…Ù†ØµØ© Ù…ØªÙƒØ§Ù…Ù„Ø© Ù„Ù„Ø·Ù„Ø§Ø¨ Ù„Ø¥Ø¬Ø±Ø§Ø¡ Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø±Ø§Øª ÙˆÙ…Ø±Ø§Ø¬Ø¹Ø© Ø§Ù„Ù†ØªØ§Ø¦Ø¬ Ø¨Ø³Ù‡ÙˆÙ„Ø© ÙˆÙØ¹Ø§Ù„ÙŠØ©." />
  <meta property="og:image" content="https://i.postimg.cc/3RBYLnd3/818334fa-20ba-431a-ad38-6bec7ef02203.png" />
  <meta property="og:url" content="https://saif1230876657.github.io/saifSAR2/" />
  <meta property="og:type" content="website" />

  <!-- Twitter Card Meta Tags -->
  <meta name="twitter:card" content="summary_large_image">
  <meta name="twitter:title" content="Ù…Ù†ØµØ© Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø±Ø§Øª Ø§Ù„ØªØ¹Ù„ÙŠÙ…ÙŠØ© Ù„Ù„Ø·Ù„Ø§Ø¨">
  <meta name="twitter:description" content="Ù…Ù†ØµØ© Ù…ØªÙƒØ§Ù…Ù„Ø© Ù„Ù„Ø·Ù„Ø§Ø¨ Ù„Ø¥Ø¬Ø±Ø§Ø¡ Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø±Ø§Øª ÙˆÙ…Ø±Ø§Ø¬Ø¹Ø© Ø§Ù„Ù†ØªØ§Ø¦Ø¬ Ø¨Ø³Ù‡ÙˆÙ„Ø© ÙˆÙØ¹Ø§Ù„ÙŠØ©.">
  <meta name="twitter:image" content="https://i.postimg.cc/3RBYLnd3/818334fa-20ba-431a-ad38-6bec7ef02203.png">

  <!-- Fonts and Icons -->
  <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;600;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  
  <style>
    /* --- CSS Variables (Themes) --- */
    :root {
      /* Light Mode */
      --bg-color: #f0f2f5; --container-bg: rgba(255, 255, 255, 0.85); --text-color: #1c1e21; --header-color: #005a9c; --accent-color: #007bff; --accent-rgb: 0, 123, 255; --accent-glow: rgba(var(--accent-rgb), 0.5); --input-bg: #ffffff; --input-border: #ccd0d5; --item-bg: #ffffff; --item-hover-bg: #f5f5f5; --shadow-color: rgba(0, 0, 0, 0.1); --success-color: #28a745; --warning-color: #ffc107; --danger-color: #dc3545;
    }
    [data-theme="dark"] {
      /* Dark Mode */
      --bg-color: #0d1117; --container-bg: rgba(22, 27, 34, 0.8); --text-color: #c9d1d9; --header-color: #58a6ff; --accent-color: #3081f7; --accent-rgb: 48, 129, 247; --accent-glow: rgba(var(--accent-rgb), 0.5); --input-bg: #0d1117; --input-border: #30363d; --item-bg: #161b22; --item-hover-bg: #21262d; --shadow-color: rgba(0, 0, 0, 0.4); --success-color: #3fb950; --warning-color: #e3b341; --danger-color: #f85149;
    }

    /* --- General Styles & Layout --- */
    *, *::before, *::after { box-sizing: border-box; }
    body { font-family: 'Cairo', sans-serif; background-color: var(--bg-color); color: var(--text-color); margin: 0; min-height: 100vh; display: flex; justify-content: center; align-items: center; direction: rtl; transition: background-color 0.5s ease, color 0.5s ease; overflow: hidden; }
    body::before { content: ''; position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: radial-gradient(circle, var(--accent-glow) 0%, transparent 40%), radial-gradient(circle, var(--header-color) 0%, transparent 50%); background-size: 200% 200%; animation: aurora 20s linear infinite; z-index: -1; }
    @keyframes aurora { from { background-position: 0% 0%; } to { background-position: -200% -200%; } }
    .container { background: var(--container-bg); backdrop-filter: blur(15px) saturate(180%); -webkit-backdrop-filter: blur(15px) saturate(180%); padding: 30px 25px 120px 25px; border-radius: 20px; border: 1px solid rgba(255, 255, 255, 0.1); width: 100%; max-width: 500px; min-height: 95vh; max-height: 95vh; overflow-y: auto; box-shadow: 0 8px 32px 0 var(--shadow-color); display: flex; flex-direction: column; position: relative; }
    section, .tab-content { animation: fadeIn 0.6s ease-out; } @keyframes fadeIn { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } } .hidden { display: none !important; }
    h1, h2, h3, h4 { text-align: center; margin-bottom: 25px; font-weight: 700; color: var(--header-color); text-shadow: 0 0 10px var(--accent-glow); }
    h4 { font-size: 1.1rem; }
    p { text-align: center; margin-top: 15px; margin-bottom: 22px; font-size: 0.9rem; } p a { color: var(--accent-color); text-decoration: none; font-weight: 600; } hr { border-top: 1px solid var(--input-border); margin: 25px 0; }
    .spinner { border: 4px solid var(--input-border); border-top: 4px solid var(--accent-color); border-radius: 50%; width: 40px; height: 40px; animation: spin 1s linear infinite; margin: 20px auto; } @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

    /* --- Buttons & Inputs --- */
    input[type="text"], input[type="password"] { width: 100%; padding: 14px 15px; margin-bottom: 22px; border: 1px solid var(--input-border); border-radius: 10px; font-size: 1rem; font-family: 'Cairo', sans-serif; background: var(--input-bg); color: var(--text-color); transition: all 0.3s ease; }
    input[type="text"]:focus, input[type="password"]:focus { outline: none; border-color: var(--accent-color); box-shadow: 0 0 0 3px var(--accent-glow); }
    button { width: 100%; padding: 14px 15px; margin-top: 10px; margin-bottom: 22px; border: none; border-radius: 10px; font-size: 1.1rem; font-family: 'Cairo', sans-serif; font-weight: 700; background: linear-gradient(45deg, var(--accent-color), var(--header-color)); color: #fff; cursor: pointer; transition: all 0.3s ease; box-shadow: 0 4px 15px var(--shadow-color); }
    button:hover { transform: translateY(-3px); box-shadow: 0 6px 20px var(--accent-glow); }

    /* --- Header & Icons --- */
    .header-icons { position: absolute; top: 20px; left: 25px; display: flex; gap: 15px; z-index: 100; }
    .icon-btn { width: 40px; height: 40px; border-radius: 50%; background: var(--item-bg); border: 1px solid var(--input-border); color: var(--text-color); display: flex; align-items: center; justify-content: center; cursor: pointer; font-size: 18px; transition: all 0.3s ease; }
    .icon-btn:hover { transform: translateY(-3px) scale(1.1); color: var(--accent-color); box-shadow: 0 0 15px var(--accent-glow); }
    #theme-toggle .fa-sun { display: none; } #theme-toggle .fa-moon { display: block; } [data-theme="dark"] #theme-toggle .fa-sun { display: block; } [data-theme="dark"] #theme-toggle .fa-moon { display: none; }

    /* --- Search & Test List --- */
    .search-container { position: relative; margin-bottom: 25px; } .search-container .fa-search { position: absolute; top: 50%; right: 15px; transform: translateY(-50%); color: var(--input-border); transition: color 0.3s ease; } #search-bar { padding-right: 40px; background: var(--input-bg); } .search-container:focus-within .fa-search { color: var(--accent-color); } .search-container:focus-within #search-bar { box-shadow: 0 0 10px var(--accent-glow), inset 0 0 5px var(--accent-glow); }
    .test-item { background: var(--item-bg); padding: 15px 20px; margin-bottom: 22px; border-radius: 12px; display: flex; justify-content: space-between; align-items: center; border: 1px solid var(--input-border); box-shadow: 0 2px 5px var(--shadow-color); transition: all 0.3s cubic-bezier(0.25, 0.8, 0.25, 1); }
    .test-item:hover { transform: translateY(-5px) scale(1.02); box-shadow: 0 8px 25px var(--shadow-color); border-color: var(--accent-color); }
    .test-item.completed { border-right: 5px solid var(--success-color); } 
    .test-item button { width: auto; padding: 8px 16px; font-size: 0.9rem; margin: 0; }
    .test-item .share-btn { background: var(--item-bg); border: 1px solid var(--input-border); color: var(--text-color); padding: 8px; border-radius: 50%; width: 36px; height: 36px; display: flex; align-items: center; justify-content: center; cursor: pointer; font-size: 16px; transition: all 0.3s ease; margin-right: 10px; box-shadow: none; }
    .test-item .share-btn:hover { transform: translateY(-2px) scale(1.05); color: var(--accent-color); box-shadow: 0 0 10px var(--accent-glow); border-color: var(--accent-color); }
    .test-item > div:last-child { display: flex; align-items: center; gap: 10px; }

    /* --- Question & Answer Styles --- */
    .question-options label { background: var(--item-bg); padding: 12px 15px; margin-bottom: 10px; border-radius: 10px; border: 1px solid var(--input-border); color: var(--text-color); cursor: pointer; transition: all 0.3s ease; display: flex; align-items: center; } 
    .question-options label:hover { border-color: var(--accent-color); background: var(--item-hover-bg); } 
    .question-options input[type="radio"] { margin-left: 10px; } 
    .question-options input[type="radio"]:checked + span { color: var(--accent-color); font-weight: bold; }

    /* --- Feedback & Result Messages --- */
    #feedback-message { font-size: 1.2rem; padding: 20px; border-radius: 12px; margin-top: 15px; font-weight: 600; text-align: center; } 
    #feedback-message.success { background: var(--success-color); color: #fff; } 
    #feedback-message.good { background: var(--accent-color); color: #fff; } 
    #feedback-message.average { background: var(--warning-color); color: #111; } 
    #feedback-message.poor { background: var(--danger-color); color: #fff; }

    /* --- Bottom Navigation --- */
    .bottom-nav { position: fixed; bottom: 20px; left: 50%; transform: translateX(-50%); width: auto; display: flex; gap: 10px; padding: 10px; background: var(--container-bg); backdrop-filter: blur(20px) saturate(180%); -webkit-backdrop-filter: blur(20px) saturate(180%); border-radius: 99px; border: 1px solid var(--input-border); box-shadow: 0 8px 32px 0 var(--shadow-color); z-index: 1000; transition: bottom 0.3s ease, opacity 0.3s ease; }
    .bottom-nav.hidden { bottom: -100px; opacity: 0; } 
    .nav-btn { display: flex; align-items: center; gap: 8px; padding: 10px 20px; background: transparent; border: none; color: var(--text-color); opacity: 0.7; border-radius: 99px; font-family: 'Cairo', sans-serif; font-size: 1rem; font-weight: 600; cursor: pointer; transition: all 0.3s ease; } 
    .nav-btn.active { opacity: 1; background: rgba(var(--accent-rgb), 0.15); color: var(--accent-color); box-shadow: 0 0 15px -5px var(--accent-glow); }

    /* --- Custom Alerts & Toasts --- */
    .custom-alert-container { position: fixed; top: 0; left: 0; width: 100%; height: 100%; display: flex; justify-content: center; align-items: center; background: rgba(0, 0, 0, 0.5); z-index: 9999; opacity: 0; visibility: hidden; transition: opacity 0.3s ease, visibility 0.3s ease; }
    .custom-alert-container.show { opacity: 1; visibility: visible; }
    .custom-alert { background: var(--item-bg); border-radius: 12px; padding: 25px 30px; margin: 20px; max-width: 400px; text-align: center; box-shadow: 0 8px 25px var(--shadow-color); transform: translateY(20px); opacity: 0; transition: transform 0.3s ease, opacity 0.3s ease; display: flex; flex-direction: column; align-items: center; }
    .custom-alert-container.show .custom-alert { transform: translateY(0); opacity: 1; }
    .custom-alert-icon { font-size: 3rem; margin-bottom: 15px; }
    .custom-alert.success .custom-alert-icon { color: var(--success-color); } .custom-alert.error .custom-alert-icon { color: var(--danger-color); } .custom-alert.warning .custom-alert-icon { color: var(--warning-color); } .custom-alert.info .custom-alert-icon { color: var(--accent-color); }
    .custom-alert-message { font-size: 1.1rem; font-weight: 600; margin-bottom: 20px; line-height: 1.5; }
    .custom-alert-close-btn { background: var(--accent-color); color: #fff; border: none; padding: 10px 25px; border-radius: 8px; font-family: 'Cairo', sans-serif; font-weight: 700; cursor: pointer; transition: background 0.3s ease; width: 100%; }
    .custom-alert-close-btn:hover { background: var(--header-color); }
    .toast-container { position: fixed; bottom: 100px; left: 50%; transform: translateX(-50%); display: flex; flex-direction: column; align-items: center; z-index: 10000; pointer-events: none; }
    .toast { background: var(--container-bg); color: var(--text-color); padding: 10px 20px; border-radius: 10px; box-shadow: 0 4px 15px var(--shadow-color); margin-bottom: 10px; opacity: 0; transform: translateY(20px); transition: opacity 0.3s ease, transform 0.3s ease; min-width: 200px; text-align: center; font-size: 0.9rem; }
    .toast.show { opacity: 1; transform: translateY(0); }
    .toast.success { border: 1px solid var(--success-color); } .toast.error { border: 1px solid var(--danger-color); } .toast.info { border: 1px solid var(--accent-color); }

    /* --- PWA Install Banner Styles --- */
    .install-banner { position: fixed; top: -150px; left: 50%; transform: translateX(-50%); width: calc(100% - 30px); max-width: 480px; background: var(--container-bg); backdrop-filter: blur(15px) saturate(180%); -webkit-backdrop-filter: blur(15px) saturate(180%); border-radius: 12px; box-shadow: 0 8px 32px 0 var(--shadow-color); border: 1px solid var(--input-border); padding: 12px 15px; z-index: 10001; display: flex; justify-content: space-between; align-items: center; transition: top 0.5s cubic-bezier(0.175, 0.885, 0.32, 1.275); }
    .install-banner.show { top: 15px; }
    .install-banner-content { display: flex; align-items: center; gap: 15px; }
    .install-banner-content img { width: 40px; height: 40px; border-radius: 8px; }
    .install-banner-content div { display: flex; flex-direction: column; }
    .install-banner-content strong { font-weight: 700; font-size: 1rem; color: var(--text-color); margin: 0; padding: 0; }
    .install-banner-content p { font-size: 0.85rem; color: var(--text-color); opacity: 0.8; margin: 0; padding: 0; text-align: right; }
    .install-banner-actions { display: flex; align-items: center; gap: 10px; }
    #install-app-btn { background: linear-gradient(45deg, var(--accent-color), var(--header-color)); color: #fff; border: none; padding: 8px 18px; border-radius: 8px; font-family: 'Cairo', sans-serif; font-weight: 700; font-size: 0.9rem; cursor: pointer; transition: all 0.3s ease; box-shadow: none; margin: 0; width: auto; }
    #install-app-btn:hover { transform: scale(1.05); box-shadow: 0 4px 15px -5px var(--accent-glow); }
    #close-install-banner-btn { background: transparent; border: none; color: var(--text-color); font-size: 2rem; font-weight: 300; line-height: 1; cursor: pointer; opacity: 0.6; transition: opacity 0.3s ease; padding: 0 5px; margin: 0; width: auto; box-shadow: none; }
    #close-install-banner-btn:hover { opacity: 1; transform: none; box-shadow: none; }
  </style>
</head>
<body data-theme="dark">

  <!-- PWA Install Banner -->
  <div id="install-banner" class="install-banner">
    <div class="install-banner-content">
      <img src="https://i.postimg.cc/3RBYLnd3/818334fa-20ba-431a-ad38-6bec7ef02203.png" alt="App Icon">
      <div>
        <strong>Ø«Ø¨Øª Ø§Ù„ØªØ·Ø¨ÙŠÙ‚</strong>
        <p>Ù„ØªØ¬Ø±Ø¨Ø© Ø£ÙØ¶Ù„ ÙˆØ£Ø³Ø±Ø¹ Ø¹Ù„Ù‰ Ø¬Ù‡Ø§Ø²Ùƒ.</p>
      </div>
    </div>
    <div class="install-banner-actions">
      <button id="install-app-btn">ØªØ«Ø¨ÙŠØª</button>
      <button id="close-install-banner-btn">&times;</button>
    </div>
  </div>

  <!-- Main App Container -->
  <div class="container">

    <!-- Custom Alerts -->
    <div id="custom-alert-container" class="custom-alert-container">
      <div id="custom-alert" class="custom-alert">
        <i id="custom-alert-icon" class="fas"></i>
        <div id="custom-alert-message" class="custom-alert-message"></div>
        <button id="custom-alert-close-btn" class="custom-alert-close-btn">Ù…ÙˆØ§ÙÙ‚</button>
      </div>
    </div>

    <!-- Toast Notifications -->
    <div id="toast-container" class="toast-container"></div>

    <!-- Header Icons -->
    <div class="header-icons">
      <div id="theme-toggle" class="icon-btn" title="ØªØ¨Ø¯ÙŠÙ„ Ø§Ù„ÙˆØ¶Ø¹"><i class="fas fa-sun"></i><i class="fas fa-moon"></i></div>
      <div id="logout-icon" class="icon-btn hidden" title="ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬"><i class="fas fa-sign-out-alt"></i></div>
    </div>

    <!-- Register Section -->
    <section id="register-section">
      <h1>ØªØ³Ø¬ÙŠÙ„ Ø¬Ø¯ÙŠØ¯</h1>
      <input type="text" id="register-name" placeholder="Ø§Ù„Ø§Ø³Ù… Ø§Ù„ÙƒØ§Ù…Ù„" />
      <input type="password" id="register-password" placeholder="ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±" />
      <button id="register-btn">ØªØ³Ø¬ÙŠÙ„</button>
      <p>Ù‡Ù„ Ù„Ø¯ÙŠÙƒ Ø­Ø³Ø§Ø¨ØŸ <a href="#" id="to-login">ØªØ³Ø¬ÙŠÙ„ Ø¯Ø®ÙˆÙ„</a></p>
    </section>

    <!-- Login Section -->
    <section id="login-section" class="hidden">
      <h1>ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„</h1>
      <input type="text" id="login-name" placeholder="Ø§Ù„Ø§Ø³Ù… Ø§Ù„ÙƒØ§Ù…Ù„" />
      <input type="password" id="login-password" placeholder="ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±" />
      <button id="login-btn">Ø¯Ø®ÙˆÙ„</button>
      <p>Ù„ÙŠØ³ Ù„Ø¯ÙŠÙƒ Ø­Ø³Ø§Ø¨ØŸ <a href="#" id="to-register">ØªØ³Ø¬ÙŠÙ„ Ø¬Ø¯ÙŠØ¯</a></p>
    </section>

    <!-- Student Dashboard Section -->
    <section id="student-dashboard-section" class="hidden">
      <h1>Ù…Ø±Ø­Ø¨Ù‹Ø§ Ø¨ÙƒØŒ <span id="student-name"></span>!</h1>
      <hr />
      <div id="tests-content" class="tab-content">
        <div class="search-container">
          <i class="fas fa-search"></i>
          <input type="text" id="search-bar" placeholder="Ø§Ø¨Ø­Ø« Ø¹Ù† Ø§Ø®ØªØ¨Ø§Ø±..." />
        </div>
        <h2>Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø±Ø§Øª Ø§Ù„Ù…ØªØ§Ø­Ø©</h2>
        <div id="available-tests-container"></div>
      </div>
      <div id="results-content" class="tab-content hidden">
        <h2>Ù†ØªØ§Ø¦Ø¬ÙŠ Ø§Ù„Ø³Ø§Ø¨Ù‚Ø©</h2>
        <div id="student-results-container"></div>
      </div>
    </section>

    <!-- Take Test Section -->
    <section id="take-test-section" class="hidden">
      <h2 id="current-test-title"></h2>
      <div id="timer" style="font-size: 1.8rem; font-weight: 700; color: var(--warning-color); text-align: center; margin-bottom: 20px;"></div>
      <div id="questions-display"></div>
      <button id="submit-test-btn">ØªØ³Ù„ÙŠÙ… Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø±</button>
      <button id="cancel-test-btn" style="background: var(--item-hover-bg); color: var(--text-color);">Ø¥Ù„ØºØ§Ø¡ Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø±</button>
    </section>

    <!-- Test Result Section -->
    <section id="test-result-section" class="hidden">
      <h1>Ù†ØªÙŠØ¬ØªÙƒ</h1>
      <h2 id="final-score" style="color: var(--header-color);"></h2>
      <div id="retake-message" class="retake-message hidden" style="color: var(--warning-color); text-align: center; font-weight: bold; margin: 15px 0; padding: 10px; background: rgba(255, 193, 7, 0.1); border-radius: 8px; border: 1px solid var(--warning-color);"></div>
      <div id="feedback-message"></div>
      <button id="back-to-dashboard-btn">Ø§Ù„Ø¹ÙˆØ¯Ø© Ù„Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ…</button>
    </section>
  </div>

  <!-- Bottom Navigation Bar -->
  <nav class="bottom-nav hidden" id="bottom-nav">
    <button id="nav-tests-btn" class="nav-btn active" data-target="tests-content"><i class="fas fa-file-alt"></i><span>Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø±Ø§Øª</span></button>
    <button id="nav-results-btn" class="nav-btn" data-target="results-content"><i class="fas fa-poll-h"></i><span>Ù†ØªØ§Ø¦Ø¬ÙŠ</span></button>
  </nav>

  <script type="module">
    // --- Firebase Initialization ---
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.7.3/firebase-app.js";
    import { getDatabase, ref, set, onValue, get, serverTimestamp } from "https://www.gstatic.com/firebasejs/11.7.3/firebase-database.js";
    const firebaseConfig = { apiKey: "AIzaSyAjE-2q6PONBkCin9ZN22gDp9Q8pAH9ZW8", authDomain: "story-97cf7.firebaseapp.com", databaseURL: "https://story-97cf7-default-rtdb.firebaseio.com", projectId: "story-97cf7", storageBucket: "story-97cf7.firebasestorage.app", messagingSenderId: "742801388214", appId: "1:742801388214:web:32a305a8057b0582c5ec17" };
    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);

    // --- DOM Element References ---
    const allSections = document.querySelectorAll('section');
    const studentDashboardSection = document.getElementById('student-dashboard-section');
    const takeTestSection = document.getElementById('take-test-section');
    const testResultSection = document.getElementById('test-result-section');
    const logoutIcon = document.getElementById('logout-icon');
    const studentNameSpan = document.getElementById("student-name");
    const availableTestsContainer = document.getElementById("available-tests-container");
    const studentResultsContainer = document.getElementById("student-results-container");
    const bottomNav = document.getElementById('bottom-nav');
    const currentTestTitle = document.getElementById("current-test-title");
    const timerDisplay = document.getElementById("timer");
    const questionsDisplay = document.getElementById("questions-display");
    const finalScoreDisplay = document.getElementById("final-score");
    const retakeMessage = document.getElementById("retake-message");
    const feedbackMessage = document.getElementById("feedback-message");
    const searchBar = document.getElementById("search-bar");
    const themeToggle = document.getElementById('theme-toggle');
    const body = document.body;

    // --- App State ---
    let currentStudent = null;
    let studentTakenTests = {};
    let allTestsData = {};
    let currentTest = null;
    let testInterval = null;
    let deepLinkInfo = null;

    // --- PWA Install Banner Logic ---
    let deferredPrompt;
    const installBanner = document.getElementById('install-banner');
    const installAppBtn = document.getElementById('install-app-btn');
    const closeInstallBannerBtn = document.getElementById('close-install-banner-btn');

    window.addEventListener('beforeinstallprompt', (e) => {
      e.preventDefault();
      deferredPrompt = e;
      if (!window.matchMedia('(display-mode: standalone)').matches) {
        showInstallBanner();
      }
    });
    function showInstallBanner() {
      installBanner.classList.add('show');
      setTimeout(hideInstallBanner, 10000); // Auto-hide after 10 seconds
    }
    function hideInstallBanner() { installBanner.classList.remove('show'); }
    closeInstallBannerBtn.addEventListener('click', hideInstallBanner);
    installAppBtn.addEventListener('click', async () => {
      hideInstallBanner();
      if (deferredPrompt) {
        deferredPrompt.prompt();
        const { outcome } = await deferredPrompt.userChoice;
        console.log(`User response to the install prompt: ${outcome}`);
        deferredPrompt = null;
      }
    });

    // --- Theme Management ---
    const applyTheme = (theme) => { body.dataset.theme = theme; localStorage.setItem('theme', theme); };
    themeToggle.onclick = () => { applyTheme(body.dataset.theme === 'dark' ? 'light' : 'dark'); };

    // --- UI & Navigation ---
    function showSection(sectionToShow) { 
      allSections.forEach(s => s.classList.add('hidden')); 
      sectionToShow.classList.remove('hidden'); 
      bottomNav.classList.toggle('hidden', sectionToShow.id !== 'student-dashboard-section'); 
    }
    function showLoadingSpinner(container) { container.innerHTML = `<div class="spinner"></div>`; }
    const navButtons = document.querySelectorAll('.nav-btn');
    const tabContents = document.querySelectorAll('.tab-content');
    navButtons.forEach(button => { 
      button.addEventListener('click', () => { 
        navButtons.forEach(btn => btn.classList.remove('active')); 
        tabContents.forEach(content => content.classList.add('hidden')); 
        button.classList.add('active'); 
        document.getElementById(button.dataset.target).classList.remove('hidden'); 
      }); 
    });
    function setDefaultTab() { document.getElementById('nav-tests-btn').click(); }
    
    // --- Core Application Logic ---
    async function updateDashboard() { 
      if (!currentStudent) return; 
      studentNameSpan.textContent = currentStudent; 
      logoutIcon.classList.remove('hidden'); 
      setDefaultTab(); 
      showLoadingSpinner(availableTestsContainer); 
      showLoadingSpinner(studentResultsContainer); 
      
      const resultsSnapshot = await get(ref(db, `studentResults/${currentStudent}`)); 
      studentTakenTests = resultsSnapshot.exists() ? resultsSnapshot.val() : {}; 
      loadStudentResults(); 
      
      const testsRef = ref(db, 'tests'); 
      onValue(testsRef, (snapshot) => { 
        allTestsData = snapshot.exists() ? snapshot.val() : {}; 
        renderAvailableTests(); 
        attemptDeepLinkStart(); 
      }, { onlyOnce: true }); // Use onlyOnce for performance, unless real-time test updates are needed
    }

    function renderAvailableTests(searchTerm = '') { 
      availableTestsContainer.innerHTML = ""; 
      let testsFound = false; 
      Object.entries(allTestsData).forEach(([teacherId, teacherTests]) => { 
        Object.entries(teacherTests).forEach(([testId, test]) => { 
          const testText = `${test.name} ${test.grade} ${teacherId}`.toLowerCase(); 
          if (searchTerm && !testText.includes(searchTerm.toLowerCase())) return; 
          
          testsFound = true; 
          const isCompleted = !!studentTakenTests[testId]; 
          const div = document.createElement('div'); 
          div.className = `test-item ${isCompleted ? 'completed' : ''}`; 
          const testShareLink = `${window.location.origin}${window.location.pathname}?testId=${testId}&teacherId=${teacherId}`;

          div.innerHTML = `
            <div>
              <strong>${test.name}</strong><br>
              <small>${test.grade} - Ø§Ù„Ù…Ø¹Ù„Ù…: ${teacherId}</small>
            </div>
            <div style="display: flex; align-items: center;">
              <button class="share-btn" title="Ù†Ø³Ø® Ø±Ø§Ø¨Ø· Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø±"><i class="fas fa-share-alt"></i></button>
              <button class="start-test-btn" style="background: ${isCompleted ? 'var(--warning-color)' : 'var(--accent-color)'}; color: ${isCompleted ? '#111' : '#fff'};">
                ${isCompleted ? 'Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø©' : 'Ø¨Ø¯Ø¡ Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø±'}
              </button>
            </div>`; 
            
          div.querySelector('.start-test-btn').onclick = () => startTest(teacherId, testId, test); 
          const shareButton = div.querySelector('.share-btn');
          shareButton.onclick = async (e) => {
            e.stopPropagation(); 
            try {
              await navigator.clipboard.writeText(testShareLink);
              const originalIcon = shareButton.innerHTML;
              shareButton.innerHTML = `<i class="fas fa-check"></i>`;
              showToast("ØªÙ… Ù†Ø³Ø® Ø§Ù„Ø±Ø§Ø¨Ø· Ø¨Ù†Ø¬Ø§Ø­!", "success");
              setTimeout(() => { shareButton.innerHTML = originalIcon; }, 1500);
            } catch (err) {
              console.error('Failed to copy text: ', err);
              showCustomAlert('ÙØ´Ù„ Ù†Ø³Ø® Ø§Ù„Ø±Ø§Ø¨Ø·. ÙŠØ±Ø¬Ù‰ Ø§Ù„Ù†Ø³Ø® ÙŠØ¯ÙˆÙŠØ§Ù‹: ' + testShareLink, "error");
            }
          };
          availableTestsContainer.appendChild(div); 
        }); 
      }); 
      if (!testsFound) { availableTestsContainer.innerHTML = "<p>Ù„Ø§ ØªÙˆØ¬Ø¯ Ø§Ø®ØªØ¨Ø§Ø±Ø§Øª Ù…Ø·Ø§Ø¨Ù‚Ø©.</p>"; } 
    }

    function loadStudentResults() { 
      studentResultsContainer.innerHTML = ""; 
      const resultsArray = Object.values(studentTakenTests).sort((a, b) => b.timestamp - a.timestamp); 
      if (resultsArray.length === 0) { studentResultsContainer.innerHTML = "<p>Ù„Ù… ØªØ­Ù„ Ø£ÙŠ Ø§Ø®ØªØ¨Ø§Ø± Ø¨Ø¹Ø¯.</p>"; return; } 
      resultsArray.forEach(result => { 
        const date = new Date(result.timestamp).toLocaleString('ar-EG', { dateStyle: 'short', timeStyle: 'short' }); 
        const div = document.createElement("div"); 
        div.style = "background: var(--item-bg); padding: 10px; border-radius: 8px; margin-bottom: 8px; border-right: 3px solid var(--accent-color)"; 
        div.innerHTML = `<strong>${result.testName}</strong> - Ø§Ù„Ø¯Ø±Ø¬Ø©: <strong>${result.score}</strong><br><small>${date}</small>`; 
        studentResultsContainer.appendChild(div); 
      }); 
    }

    async function saveUser(name, password) { 
      const userRef = ref(db, `students/${name}`); 
      if ((await get(userRef)).exists()) { showCustomAlert("Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ù‡Ø°Ø§ Ù…ÙˆØ¬ÙˆØ¯ Ø¨Ø§Ù„ÙØ¹Ù„.", "error"); return false; } 
      await set(userRef, { password: password }); 
      return true; 
    }

    async function verifyUser(name, password) { 
      const snapshot = await get(ref(db, `students/${name}`)); 
      return snapshot.exists() && snapshot.val().password === password; 
    }
    
    function startTest(teacherId, testId, testData) {
      if (studentTakenTests[testId] && testData.allowRetake !== true) {
        showCustomAlert("ØªÙ†Ø¨ÙŠÙ‡: Ù„Ù‚Ø¯ Ø£ÙƒÙ…Ù„Øª Ù‡Ø°Ø§ Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø± Ù…Ø³Ø¨Ù‚Ù‹Ø§. Ù‡Ø°Ù‡ Ù…Ø­Ø§ÙˆÙ„Ø© Ù„Ù„Ù…Ø±Ø§Ø¬Ø¹Ø© ÙÙ‚Ø·ØŒ ÙˆÙ„Ù† ÙŠØªÙ… ØªØ­Ø¯ÙŠØ« Ù†ØªÙŠØ¬ØªÙƒ Ø§Ù„Ø£ØµÙ„ÙŠØ©.", "info");
      }
      currentTest = { ...testData, id: testId, teacherId: teacherId };
      currentTestTitle.textContent = currentTest.name;
      let currentTestDuration = currentTest.duration * 60;
      
      questionsDisplay.innerHTML = "";
      if (currentTest.questions && Array.isArray(currentTest.questions)) {
        currentTest.questions.forEach((q, qIndex) => {
          const questionDiv = document.createElement("div");
          questionDiv.style.marginBottom = "25px";
          questionDiv.innerHTML = `<h4>Ø§Ù„Ø³Ø¤Ø§Ù„ ${qIndex + 1}: ${q.question}</h4>${q.image ? `<img src="${q.image}" alt="ØµÙˆØ±Ø© Ø§Ù„Ø³Ø¤Ø§Ù„" style="max-width: 100%; border-radius: 10px; margin-top: 10px; margin-bottom: 15px;">` : ''}`;
          const optionsDiv = document.createElement("div");
          optionsDiv.className = "question-options";
          q.options.forEach((option, oIndex) => {
            optionsDiv.innerHTML += `<label><input type="radio" name="question-${qIndex}" value="${oIndex + 1}" /><span>${option}</span></label>`;
          });
          questionDiv.appendChild(optionsDiv);
          questionsDisplay.appendChild(questionDiv);
        });
      }
      
      if (testInterval) clearInterval(testInterval);
      timerDisplay.textContent = formatTime(currentTestDuration);
      testInterval = setInterval(() => {
        currentTestDuration--;
        timerDisplay.textContent = formatTime(currentTestDuration);
        if (currentTestDuration < 0) {
          clearInterval(testInterval);
          submitTest(true);
        }
      }, 1000);
      showSection(takeTestSection);
    }
    
    async function submitTest(timeUp = false) { 
      clearInterval(testInterval); 
      if (timeUp) showCustomAlert("Ø§Ù†ØªÙ‡Ù‰ ÙˆÙ‚Øª Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø±!", "warning"); 
      
      let answers = {}; 
      currentTest.questions.forEach((_, qIndex) => { 
        const checked = document.querySelector(`input[name="question-${qIndex}"]:checked`); 
        if (checked) answers[qIndex] = parseInt(checked.value); 
      }); 
      
      let score = 0; 
      currentTest.questions.forEach((q, qIndex) => { if (answers[qIndex] === q.correct) score++; }); 
      
      const percentage = (score / currentTest.questions.length) * 100; 
      let feedbackText, feedbackClass; 
      if (percentage === 100) { feedbackText = "Ù…Ø°Ù‡Ù„! Ù„Ù‚Ø¯ Ø­ØµÙ„Øª Ø¹Ù„Ù‰ Ø§Ù„Ø¯Ø±Ø¬Ø© Ø§Ù„ÙƒØ§Ù…Ù„Ø©! ğŸ¤©"; feedbackClass = "success"; } 
      else if (percentage >= 80) { feedbackText = "Ø¹Ù…Ù„ Ø±Ø§Ø¦Ø¹! Ù†ØªÙŠØ¬ØªÙƒ Ù…Ù…ØªØ§Ø²Ø©! âœ¨"; feedbackClass = "good"; } 
      else if (percentage >= 50) { feedbackText = "Ù†ØªÙŠØ¬Ø© Ø¬ÙŠØ¯Ø©! Ø§Ø³ØªÙ…Ø± Ø¨Ø§Ù„ØªÙ‚Ø¯Ù…! ğŸ‘"; feedbackClass = "average"; } 
      else { feedbackText = "Ù„Ø§ ØªÙ‚Ù„Ù‚! ÙƒÙ„ Ø§Ø®ØªØ¨Ø§Ø± ÙØ±ØµØ© Ù„Ù„ØªØ¹Ù„Ù…. ğŸ’ª"; feedbackClass = "poor"; } 
      
      retakeMessage.classList.add('hidden'); 
      if (!studentTakenTests[currentTest.id]) { 
        const resultData = { testName: currentTest.name, teacherName: currentTest.teacherId, score: `${score}/${currentTest.questions.length}`, timestamp: serverTimestamp() }; 
        await set(ref(db, `studentResults/${currentStudent}/${currentTest.id}`), resultData); 
        await set(ref(db, `results/${currentTest.teacherId}/${currentTest.id}/${currentStudent}`), resultData.score); 
        studentTakenTests[currentTest.id] = resultData; 
      } else { 
        retakeMessage.textContent = "Ù‡Ø°Ù‡ Ù…Ø­Ø§ÙˆÙ„Ø© Ù„Ù„Ù…Ø±Ø§Ø¬Ø¹Ø©. ØªÙ… Ø§Ù„Ø§Ø­ØªÙØ§Ø¸ Ø¨Ù†ØªÙŠØ¬ØªÙƒ Ø§Ù„Ø£ÙˆÙ„Ù‰."; 
        retakeMessage.classList.remove('hidden'); 
      } 
      
      finalScoreDisplay.textContent = `Ø¯Ø±Ø¬ØªÙƒ: ${score} Ù…Ù† ${currentTest.questions.length}`; 
      feedbackMessage.className = ``; 
      feedbackMessage.classList.add(feedbackClass); 
      feedbackMessage.textContent = feedbackText; 
      showSection(testResultSection); 
    }

    function cancelTest() { 
      if (confirm("Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø¥Ù„ØºØ§Ø¡ Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø±ØŸ Ø³ÙŠØªÙ… ÙÙ‚Ø¯Ø§Ù† ØªÙ‚Ø¯Ù…Ùƒ.")) { 
        clearInterval(testInterval); 
        showSection(studentDashboardSection); 
        updateDashboard(); 
      } 
    } 

    async function attemptDeepLinkStart() {
      if (deepLinkInfo && currentStudent && Object.keys(allTestsData).length > 0) {
        const { testId, teacherId } = deepLinkInfo;
        const testToStart = allTestsData[teacherId]?.[testId];
        if (testToStart) {
          if (studentDashboardSection.classList.contains('hidden')) showSection(studentDashboardSection);
          startTest(teacherId, testId, testToStart);
        } else {
          showCustomAlert("Ø¹Ø°Ø±Ø§Ù‹ØŒ Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø± Ø§Ù„Ù…Ø­Ø¯Ø¯ Ø¨Ø§Ù„Ø±Ø§Ø¨Ø· ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯ Ø£Ùˆ Ø§Ù„Ù…Ø¹Ù„Ù… ØºÙŠØ± ØµØ­ÙŠØ­.", "error");
        }
        deepLinkInfo = null;
      }
    }

    // --- Event Listeners ---
    document.getElementById('login-btn').onclick = async () => { 
      const name = document.getElementById("login-name").value.trim(); 
      const password = document.getElementById("login-password").value.trim(); 
      if (!name || !password) return showCustomAlert("Ø§Ù„Ø±Ø¬Ø§Ø¡ ØªØ¹Ø¨Ø¦Ø© Ø§Ù„Ø§Ø³Ù… ÙˆÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±.", "warning");
      if (await verifyUser(name, password)) { 
        currentStudent = name; 
        localStorage.setItem("loggedInStudent", currentStudent); 
        showSection(studentDashboardSection); 
        await updateDashboard(); 
      } else { 
        showCustomAlert("Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø£Ùˆ ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± ØºÙŠØ± ØµØ­ÙŠØ­Ø©.", "error"); 
      } 
    };

    document.getElementById('register-btn').onclick = async () => { 
      const name = document.getElementById("register-name").value.trim(); 
      const password = document.getElementById("register-password").value.trim(); 
      if(!name || !password) return showCustomAlert("Ø§Ù„Ø±Ø¬Ø§Ø¡ ØªØ¹Ø¨Ø¦Ø© ÙƒÙ„ Ø§Ù„Ø­Ù‚ÙˆÙ„", "warning");
      if (await saveUser(name, password)) { 
        showCustomAlert("ØªÙ… Ø§Ù„ØªØ³Ø¬ÙŠÙ„ Ø¨Ù†Ø¬Ø§Ø­! ÙŠÙ…ÙƒÙ†Ùƒ Ø§Ù„Ø¢Ù† ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„.", "success");
        document.getElementById("login-name").value = name;
        document.getElementById("login-password").value = "";
        showSection(document.getElementById('login-section')); 
      } 
    };

    logoutIcon.onclick = () => { 
      if (confirm("Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø±ØºØ¨ØªÙƒ ÙÙŠ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬ØŸ")) {
        currentStudent = null; 
        localStorage.removeItem("loggedInStudent"); 
        showSection(document.getElementById('login-section')); 
        logoutIcon.classList.add('hidden'); 
      } 
    };

    searchBar.addEventListener('input', (e) => renderAvailableTests(e.target.value));
    document.getElementById('submit-test-btn').onclick = () => submitTest(false);
    document.getElementById('cancel-test-btn').onclick = cancelTest;
    document.getElementById('back-to-dashboard-btn').onclick = () => { showSection(studentDashboardSection); updateDashboard(); };
    document.getElementById('to-login').onclick = (e) => { e.preventDefault(); showSection(document.getElementById('login-section')); };
    document.getElementById('to-register').onclick = (e) => { e.preventDefault(); showSection(document.getElementById('register-section')); };
    
    // --- Custom Alert & Toast Functions ---
    const customAlertContainer = document.getElementById('custom-alert-container');
    const customAlert = document.getElementById('custom-alert');
    const customAlertIcon = document.getElementById('custom-alert-icon');
    const customAlertMessage = document.getElementById('custom-alert-message');
    const customAlertCloseBtn = document.getElementById('custom-alert-close-btn');
    const toastContainer = document.getElementById('toast-container');

    function hideCustomAlert() {
      customAlertContainer.classList.remove('show');
    }
    customAlertCloseBtn.onclick = hideCustomAlert;
    customAlertContainer.onclick = (e) => { if (e.target === customAlertContainer) hideCustomAlert(); };

    function showCustomAlert(message, type = 'info') {
      customAlertMessage.textContent = message;
      customAlert.className = 'custom-alert ' + type;
      const icons = { success: 'fa-check-circle', error: 'fa-times-circle', warning: 'fa-exclamation-triangle', info: 'fa-info-circle' };
      customAlertIcon.className = `fas ${icons[type] || icons.info}`;
      customAlertContainer.classList.add('show');
    }

    function showToast(message, type = 'info', duration = 3000) {
      const toast = document.createElement('div');
      toast.className = `toast ${type}`;
      toast.textContent = message;
      toastContainer.appendChild(toast);
      setTimeout(() => toast.classList.add('show'), 10);
      setTimeout(() => {
        toast.classList.remove('show');
        toast.addEventListener('transitionend', () => toast.remove());
      }, duration);
    }
    function formatTime(seconds) { 
      const minutes = Math.floor(seconds / 60); 
      const remainingSeconds = seconds % 60; 
      return `${minutes.toString().padStart(2, '0')}:${remainingSeconds.toString().padStart(2, '0')}`; 
    }

    // --- PWA Service Worker ---
    if ('serviceWorker' in navigator) {
      window.addEventListener('load', () => {
        navigator.serviceWorker.register('./service-worker.js')
          .then(reg => console.log('ServiceWorker registration successful:', reg.scope))
          .catch(err => console.log('ServiceWorker registration failed:', err));
      });
    }

    // --- Initial Load Logic ---
    window.onload = async () => { 
      applyTheme(localStorage.getItem('theme') || 'dark');
      
      const urlParams = new URLSearchParams(window.location.search);
      const testIdParam = urlParams.get('testId');
      const teacherIdParam = urlParams.get('teacherId');
      if (testIdParam && teacherIdParam) {
        deepLinkInfo = { testId: testIdParam, teacherId: teacherIdParam };
        history.replaceState({}, document.title, window.location.pathname);
      }

      const savedStudent = localStorage.getItem("loggedInStudent"); 
      if (savedStudent) { 
        currentStudent = savedStudent; 
        showSection(studentDashboardSection); 
        await updateDashboard(); 
      } else {
        // If there's a deep link, show login first instead of register
        showSection(deepLinkInfo ? document.getElementById('login-section') : document.getElementById('register-section'));
      } 
    };
  </script>
</body>
</html>
